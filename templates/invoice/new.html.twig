{% extends 'base.html.twig' %}

{% block title %}Nouvelle Facture
{% endblock %}

{% block body %}
	<style>
		body {
			font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
			background: #f0f2f5;
			color: #222;
			margin: 0;
			padding: 0;
		}
		h1 {
			text-align: center;
			font-size: 2em;
			margin-bottom: 1em;
			color: #273c75;
		}
		.form-card {
			background: #fff;
			max-width: 800px;
			margin: 2em auto;
			border-radius: 12px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
			padding: 2em;
		}
		fieldset {
			border: 1px solid #dcdde1;
			border-radius: 8px;
			margin-bottom: 2em;
			padding: 1.5em;
			background: #fafafa;
		}
		legend {
			font-size: 1.2em;
			font-weight: 600;
			color: #0097e6;
			padding: 0 0.5em;
		}
		label {
			display: block;
			margin-bottom: 0.8em;
			color: #2f3640;
		}
		input,
		select {
			width: 95%;
			padding: 0.5em;
			margin-top: 3px;
			border: 1px solid #dcdde1;
			border-radius: 6px;
			font-size: 1em;
			background: #fff;
		}
		input:focus,
		select:focus {
			border-color: #0097e6;
			outline: none;
		}
		.flash-success {
			background: #4cd137;
			color: #fff;
			padding: 0.7em 1em;
			border-radius: 6px;
			margin-bottom: 1em;
			text-align: center;
		}
		.line-item {
			background: #f9f9f9;
			margin-bottom: 1.5em;
			padding: 1em;
			border-radius: 8px;
			border-left: 4px solid #0097e6;
		}
		.allowances {
			margin-top: 1em;
			padding-left: 1em;
		}
		button[type="button"],
		button[type="submit"] {
			padding: 0.7em 1.3em;
			border-radius: 8px;
			border: none;
			background: #0097e6;
			color: #fff;
			font-size: 1em;
			cursor: pointer;
			transition: background 0.2s;
			margin-top: 1em;
		}
		button[type="button"]:hover,
		button[type="submit"]:hover {
			background: #4078c0;
		}
	</style>

	<div class="form-card">
		<h1>Créer une nouvelle facture</h1>

		{% for message in app.flashes('success') %}
			<div class="flash-success">{{ message }}</div>
		{% endfor %}

		<form method="post" action="{{ path('invoice_create_facturx') }}">
			<fieldset>
				<legend>Informations de la facture</legend>
				<label>Numéro de facture
					<input type="text" name="invoiceNumber" required>
				</label>
				<label>Date
					<input type="date" name="issueDate" value="{{ "now"|date('Y-m-d') }}" required>
				</label>
				<label>Devise
					<input type="text" name="currency" value="EUR">
				</label>
				<label>Référence paiement
					<input type="text" name="paymentReference">
				</label>
				<label>Note
					<input type="text" name="note">
				</label>
			</fieldset>

			<fieldset>
				<legend>Vendeur</legend>
				<label>Nom
					<input type="text" name="seller[name]">
				</label>
				<label>Adresse
					<input type="text" name="seller[address]">
				</label>
				<label>Ville
					<input type="text" name="seller[city]">
				</label>
				<label>Code postal
					<input type="text" name="seller[zip]">
				</label>
				<label>Pays
					<input type="text" name="seller[country]">
				</label>
			</fieldset>

			<fieldset>
				<legend>Acheteur</legend>
				<label>Nom
					<input type="text" name="buyer[name]">
				</label>
				<label>Adresse
					<input type="text" name="buyer[address]">
				</label>
				<label>Ville
					<input type="text" name="buyer[city]">
				</label>
				<label>Code postal
					<input type="text" name="buyer[zip]">
				</label>
				<label>Pays
					<input type="text" name="buyer[country]">
				</label>
			</fieldset>

			<fieldset id="lines-fieldset">
				<legend>Lignes de facture</legend>
				<div class="line-item">
					<label>Produit
						<input type="text" name="lines[0][productName]" required>
					</label>
					<label>Description
						<input type="text" name="lines[0][description]">
					</label>
					<label>Quantité
						<input type="number" step="0.01" name="lines[0][quantity]" value="1">
					</label>
					<label>Prix net
						<input type="number" step="0.01" name="lines[0][netPrice]">
					</label>
					<label>Prix brut
						<input type="number" step="0.01" name="lines[0][grossPrice]">
					</label>
					<label>TVA %
						<input type="number" step="0.01" name="lines[0][taxRate]">
					</label>
					<label>Unité
						<input type="text" name="lines[0][unit]" value="NAR">
					</label>
					<div class="allowances">
						<h4>Remises & Charges</h4>
						<div class="allowance-item">
							<label>Type
								<select name="lines[0][allowances][0][charge]">
									<option value="0">Remise</option>
									<option value="1">Charge</option>
								</select>
							</label>
							<label>Montant
								<input type="number" step="0.01" name="lines[0][allowances][0][amount]">
							</label>
							<label>Raison
								<input type="text" name="lines[0][allowances][0][reason]">
							</label>
						</div>
					</div>
				</div>
			</fieldset>

			<button type="button" id="add-line-btn">Ajouter une ligne</button>
			<br><br>
			<button type="submit">Créer Facture</button>
		</form>
	</div>

	<script>
		(function () { // On stocke lineIndex sur window pour éviter plusieurs déclarations
window.lineIndex = window.lineIndex || 1;

document.getElementById('add-line-btn').addEventListener('click', function () {
const fieldset = document.getElementById('lines-fieldset');
const newLine = document.querySelector('.line-item').cloneNode(true);

newLine.querySelectorAll('input, select').forEach(input => {
input.name = input.name.replace(/\d+/, window.lineIndex);

// Remettre les valeurs à vide sauf texte par défaut
if (input.type !== 'text') {
input.value = '';
}
});

fieldset.appendChild(newLine);
window.lineIndex ++;
});
})();
	</script>

{% endblock %}
